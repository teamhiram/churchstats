# 召会生活統計システム 完全仕様書 (spec3)

## 1. プロジェクト概要

* **目的:** 召会生活におけるメンバー管理、出欠確認、および統計分析の自動化。
* **開発スタック:** Cursor (React/Next.js), Supabase (Auth/DB/Edge Functions), Vercel (Hosting).
* **主要管理者:** `tatsuya.n@gmail.com`

### 1.1 開発環境

* Cursor で開発（React/Next.js）。
* リポジトリは **Github に Private で登録**。
* **Github 経由で Vercel にデプロイ**しホスティングする。

---

## 2. システム構成・データ構造

### 2.1 組織階層

1. **地方 (Locality):** 最上位区分（例：調布、東京、町田。管理者が追加可能。当初は調布のみ）。
2. **地区 (District):** 地方の下位区分。報告の基本単位。
3. **小組 (Group):** 地区を細分化したグループ。最小単位。ローカルメンバーは原則いずれかの小組に所属させる。
* **無所属リスト:** 所属が決まっていないメンバーの一時待機場所。ここから振り分け先（小組等）に割り当てる。

### 2.2 集会の名称ルール

* **主日集会:** 地区集会。名前は「XX地区集会」「OO地区集会」の形式（合同集会）。
* **小組集会:** 名前は「XX小組」の形式で付ける。

### 2.3 データベース設計 (Table Schema)

#### ① 組織・グループ系

* `localities`: `id`, `name`
* `districts`: `id`, `locality_id`, `name`
* `groups`: `id`, `district_id`, `name`

#### ② メンバー系 (`members`)

* `id` (UUID), `name`, `gender`, `is_local` (ローカル/ゲスト)
* `current_category` (大人/大学生/高校生/中学生/小学生/子供)
* `is_baptized` (boolean)
* `baptism_date` (year, month, day 分割保持 / 月日不明可)
* `baptism_date_precision` (確定/不明/おおよそ)
* **`languages`:** `main`（母語、または配信されるメルマガの言語の好み）, `sub`（メインの他に話せる言語・注）
* `follower_id`（欠席した時にフォローする人）, `vital_group_id`（日常的に関わりあう3–4名・地方のリストから選択）, `group_id`

#### ③ 出席記録系 (`attendance_records`) ※スナップショット方式

* `id`, `event_date`, `meeting_type` (主日/小組), `member_id`
* **`recorded_category`**: 報告時点の区分 (統計用)
* **`recorded_is_baptized`**: 報告時点のバプテスマ状態 (統計用)
* `district_id`, `group_id`: 報告時点の所属

#### ④ 履歴管理系 (`attribute_histories`)

* `member_id`, `attribute_type` (区分/バプテスマ), `old_value`, `new_value`, `changed_at`

---

## 3. 出欠報告・運用機能

### 3.1 報告の仕方

* 報告は**地区ごと**に行う。
* 報告者には**あらかじめ所属地区の統計画面が表示**される。
* **別地区についても報告**することができる。

### 3.2 報告プロセス（スマート追加機能）

* **出席候補者リスト（レギュラーメンバーリスト）:** 各集会に紐づくリスト。集会ごとにリストを作成でき、いち早く出席者を登録できる。集会作成時には所属メンバーを自動展開。
* **フリー入力検索:** 出席報告画面に検索窓を設置。
* **既存一致:** 名簿にある場合は候補を表示し、選択して出席登録。
* **新規追加:** 名簿にない場合、その場で「新規友人」として簡易登録（氏名・性別・区分等）し、そのまま出席処理を行う。

### 3.3 年度更新サポート（3月末）

* **進級対象者リスト:** 毎年3月末に、学年（区分）の変更可能性があるメンバーを自動抽出（例：小6）。
* **一括更新提案:** システムが次年度の区分（中1など）を提案。管理者は「承認・変更・却下」を選択するだけで一括更新が可能。

### 3.4 名簿統合（重複排除）

* 同一人物を誤って二重登録した場合、一方をメインとして統合。
* 過去の `attendance_records` の `member_id` を全てメイン側に書き換え、重複データを削除する。

---

## 4. 小組リスト・名簿運用

* 召会全体の所属が「ローカル」のメンバーを**もれなくどれか一つの小組に所属**させる。
* **小組の作成**は管理者のみが行える。
* **小組へのメンバー追加・削除**は、報告者でも行える（※権限マトリクス 6 参照）。
* 無所属リストから振り分け先の小組に割り当てる。

---

## 5. データ整合性と統計

### 5.1 統計データの整合性

* **時点データの保持:** 後からメンバーの現在属性が変わっても、過去の統計結果（「子供の出席数」など）が変わらないよう、報告時の値を保持する。
* **不整合アラート:** `attendance_records` の値と `attribute_histories` から逆算される「本来の属性」を照合。矛盾がある場合に警告を表示。
* **遡り修正:** 属性変更漏れが判明した場合、過去の統計データを一括修正できる機能を提供。

### 5.2 統計ダッシュボード

* サイトの**トップにはダッシュボード**を表示する。
* **召会全体・地区ごと・小組ごと**の重要な統計結果を視覚的に提示する。
* **重要指標:** 期間別・属性別（男/女、聖徒/友人、大人/子供）の人数推移グラフ。
* **グラフ・テーブルの集計期間をユーザーが変更できる**ようにする。
* **アクティブ率:** 過去4週間の出席率（1回以上出席した割合）。
* **欠席アラート:** 過去(X)週間出席していた「ローカル」メンバーの今週欠席リストを表示。

---

## 6. 権限マトリクス

| 権限 | ユーザー管理 | 組織・小組設定 | 小組名簿の追加・削除 | 名簿統合・遡り修正 | 集会作成・出欠報告 | レギュラーメンバーリスト作成 | 統計閲覧 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| **管理者** | 全て | ○ | ○ | ○ | ○ | ○ | ○ |
| **共同管理者** | 報告者承認等(※1) | ○ | ○ | ○ | ○ | ○ | ○ |
| **報告者** | × | × | ○(※2) | × | ○ | ○ | ○ |
| **閲覧者** | × | × | × | × | × | × | ○ |

* **(※1)** 共同管理者は、管理者のアカウント設定（パスワード・メールアドレス等）を変更できない。管理者は共同管理者を削除できる。管理者・共同管理者は複数存在できる。
* **(※2)** 報告者は小組の「作成・削除・名前変更」はできないが、小組名簿へのメンバー追加・削除は可能。

---

## 7. 管理者・ユーザー管理機能

### 7.1 管理者の権限

* 管理者の**メールアドレスを変更**する機能。
* **管理者・共同管理者の追加:** 苗字、名前、メールアドレス、ロール（管理者・共同管理者・報告者・閲覧者）。
* **報告者の承認・却下・削除。**
* **小組の作成。**

### 7.2 報告者の追加フロー

* 報告者追加時：メールアドレスを指定。**パスワードは初期ランダム自動生成**し、**メールで通知**する。
* **初回ログイン後、パスワード変更を推奨するメッセージ**を表示する。

### 7.3 報告者の権限（明示）

* **集会の作成**
* **小組名簿へのメンバー追加・削除**
* **レギュラーメンバーリスト（出席候補者リスト）の作成**
