# spec3 仕様書 検証レポート（PM視点）

## 1. 抜け漏れ（未定義・未記載）

### 1.1 データモデル・テーブル

| 項目 | 内容 |
| --- | --- |
| **集会（イベント）テーブル** | 主日集会・小組集会の「1回の集会」を表すエンティティが未定義。`attendance_records` には `event_date`, `meeting_type` があるが、「どの地区の主日」「どの小組の小組集会か」を紐づける `meeting_id` や `district_id` が attendance 側にはある。集会そのもの（例：2025-02-02 調布地区集会）を登録するテーブル・作成フローが仕様にない。 |
| **レギュラーメンバーリストの構造** | 「各集会に紐づくリスト」とあるが、テーブル名・カラム（集会ID、メンバーID、並び順等）が書かれていない。 |
| **ユーザー・ロールのテーブル** | 管理者・共同管理者・報告者・閲覧者のアカウント、ロール、**報告者の所属地区**をどこに持つか未記載。Supabase Auth と連携する `profiles` や `user_roles`, `reporter_districts` 等の想定が必要。 |
| **メンバーの所属（地区）** | メンバーは `group_id`（小組）のみ。小組は `district_id` に属するので地区は導出できるが、「このメンバーがどの地区に属するか」を明示する `district_id` を members に持つか、小組経由のみかが仕様上あいまい。報告の「所属地区」表示や統計で必要。 |
| **vital_group の実体** | 「日常的に関わりあう3–4名（地方のリストから選べる）」とある。`vital_group_id` が別テーブル（例：vital_groups + vital_group_members）なのか、単に「メンバーIDのリスト」をJSON等で持つのか未定義。 |

### 1.2 用語・指標の定義

| 項目 | 内容 |
| --- | --- |
| **聖徒 / 友人** | 統計軸（男/女、聖徒/友人、大人/子供）にあるが、メンバー属性として定義がない。バプテスマ済み＝聖徒・未＝友人でよいか、別フラグがあるかを明記した方がよい。 |
| **欠席アラートの「X」** | 「過去(X)週間出席していたが今週欠席」の X のデフォルト値・変更可否（設定画面で変更できるか）が未定義。 |
| **集計期間** | 「集計期間をユーザーが変更できる」とあるが、デフォルト（例：直近4週間）、選択肢（週/月/四半期/年）、上限（例：過去2年まで）が未定義。 |
| **「子供」の範囲** | `current_category` に「子供」と「小学生/中学生…」が並んでいる。統計の「大人/子供」の「子供」は category のどれに相当するか（小学生以下など）を定義した方がよい。 |

### 1.3 フロー・画面

| 項目 | 内容 |
| **報告者の承認フロー** | 「報告者の承認・却下・削除」とある。報告者は「申請して承認される」のか、管理者が「メールで追加するだけ」なのかが書かれていない。招待のみか、申請＋承認かで画面・通知が変わる。 |
| **集会の作成フロー** | 誰が・いつ・どの情報（日付、地区 or 小組、名前）で「1回の集会」を作るか。主日は地区単位で1日1集会か、複数あるか。小組集会は小組ごとに日付を選んで作成するか。 |
| **出席報告の確定・訂正** | 報告は即時保存か、確定ボタンがあるか。後から訂正・取消は可能か、可能なら誰が・いつまでか。 |
| **メンバーの無効化・退会** | メンバーを「削除」するか「退会」等で無効化するか。無効化した場合、過去の出席履歴は残すか、統計から除外するか。 |
| **ログイン・認証** | 初回ログイン以外のログイン/ログアウト、パスワード忘れ、メール変更、アカウント無効化時の挙動が未記載。 |
| **トップ・ダッシュボードの対象** | 閲覧者・報告者・管理者で、トップに表示するダッシュボードの範囲（全体のみか、自分が担当する地区のみも選べるか）が書かれていない。 |

### 1.4 非機能要件

| 項目 | 内容 |
| --- | --- |
| **監査ログ** | 誰がいつ・どのデータを変更したかの記録が必要か未記載。権限が複数あるため、後から追跡できるとよい。 |
| **同時編集・競合** | 同じ集会の出席を複数人が同時に報告した場合の扱い（ロック、マージ、後勝ち等）が未定義。 |
| **バックアップ・リストア** | 運用で必要な場合、方針があるとよい。 |
| **UI言語** | 日本語のみか、多言語対応するか未記載。 |

---

## 2. 齟齬・不整合

### 2.1 参照番号の誤り

| 箇所 | 内容 |
| --- | --- |
| **4. 小組リスト** | 「※権限マトリクス **5** 参照」とあるが、権限マトリクスは **セクション6**。→「6 参照」に修正すべき。 |

### 2.2 データ構造と説明のずれ

| 項目 | 内容 |
| --- | --- |
| **attendance_records の district_id / group_id** | 「報告時点の所属」とある。主日集会は地区単位なので `district_id` で集会を特定するか、別に「集会ID」を持つか。小組集会は `group_id` で小組を特定できる。主日と小組で「集会」の特定方法が揃っているか、スキーマで整理した方がよい。 |
| **バイタルグループと小組** | 小組は「地区を細分化したグループ」で、バイタルグループは「3–4名の人（地方のリストから選べる）」。小組とは別概念だが、`vital_group_id` が `groups` テーブルを参照する設計だと小組と混同する。別エンティティならテーブルを分けるか、説明で区別する必要がある。 |

### 2.3 権限・運用の解釈のぶれ

| 項目 | 内容 |
| --- | --- |
| **報告者の所属** | 「報告者にはあらかじめ所属地区の統計画面が表示」とあるが、報告者が「1地区に固定」か「複数地区を担当可」かが書かれていない。複数可の場合、初期表示を「メイン担当地区」にするかなどルールが必要。 |
| **小組の作成者** | 「管理者のみが小組を作成できる」と 4. にあり、権限マトリクスでは「組織・小組設定」が共同管理者も ○。共同管理者は小組を作成できるか、管理者のみに限定するか、どちらかに揃える必要がある。 |

---

## 3. エッジケース・例外処理（未定義）

| 項目 | 内容 |
| --- | --- |
| **最後の1人の管理者** | 管理者が自分を削除したりロール変更したりして、管理者が0人にならないようにする制御があるか。 |
| **小組・地区の削除** | 小組を削除した場合、所属メンバーを無所属リストに移すか。地区を削除する場合、下位の小組・集会・出席履歴をどうするか。 |
| **名簿統合の取り消し** | 統合を誤った場合のロールバックや、統合履歴の保持の有無。 |
| **メール送信失敗** | 報告者追加時のパスワード通知メールが失敗した場合の再送・手順。 |
| **重複ログイン・セッション** | 同一アカウントの複数デバイス・タブの扱い（制限するか、許可するか）。 |

---

## 4. 仕様の明確化を推奨する点

1. **「集会」をファーストクラスのエンティティとして定義する**  
   - 主日集会・小組集会それぞれについて、日付・地区 or 小組・名前を持つ `meetings`（または `events`）テーブルを想定し、`attendance_records` は `meeting_id` を参照する形にすると、レギュラーメンバーリストや報告フローが説明しやすい。
2. **報告者と地区の紐付けを明示する**  
   - 報告者が担当する地区（1つまたは複数）、および「初期表示する地区」のルールを仕様に書く。
3. **聖徒/友人の定義を1行で書く**  
   - 例：「バプテスマ済みを聖徒、未を友人として統計に使用する」など。
4. **共同管理者が小組を作成できるかどうかを権限と文章で一致させる**  
   - 4. の「管理者のみ」と、権限マトリクス「組織・小組設定」の共同管理者○の両立（例：「組織・小組設定は管理者・共同管理者が行う。小組の作成はその一環とする」など）。
5. **ゲストの小組所属**  
   - 「ローカルをもれなく小組に」とあるので、ゲストは小組に所属させない前提でよいか、一言あるとよい。
6. **閲覧者が見られる範囲**  
   - 召会全体のみか、地区・小組を選んで見られるか。権限が「統計閲覧」のみなので、範囲の制限があれば書く。

---

## 5. まとめ

| カテゴリ | 件数（目安） |
| --- | --- |
| 抜け漏れ（データ・用語・フロー・非機能） | 約20項目 |
| 齟齬・不整合 | 参照番号1、データ/権限の解釈 数箇所 |
| エッジケース・例外 | 約5項目 |

**推奨:** 次版（spec4 または仕様の更新）で、  
① 集会・レギュラーメンバーリスト・ユーザー/報告者所属のテーブルとフローを追加、  
② 聖徒/友人・集計期間・欠席アラートのX・子供の範囲を定義、  
③ 報告者承認フロー・集会作成・出席確定/訂正・メンバー無効化を簡潔に記載、  
④ 参照番号の修正と「組織・小組設定」と「小組の作成は管理者のみ」の整合を取ると、実装時の解釈のぶれが減ります。
