# ChurchStats v0.2 トラブルシューティング記録

v0.2（枠組設定の小組・地区編集など）にまつわる現象・原因・対処法・対処結果を記録する。

**本ドキュメントで扱う事象一覧**

| # | 概要 |
|---|------|
| 1 | 小組編集機能実装後に画面が真っ白になる（null 安全・エラーバウンダリ） |
| 2 | 上記対応後もまだまっ白（環境変数未設定時のサーバー側 throw） |
| 3 | 小組「編集」ボタン無反応・URL が変わらない |
| 4 | 編集モードでテキストフィールドに元の値が表示されない |
| 5 | v0.2 でのその他の注意・安定化のポイント |

**関連:** ReleaseNote_0.2.md（機能変更一覧）、Troubleshooting_0.1.md（v0.1 の事象）

---

## 1. 小組編集機能実装後に画面が再び真っ白になる

### 現象
- 枠組設定で小組の編集・削除機能を追加したあと、画面が再び真っ白になる。

### 原因
- 小組一覧や地区リストのデータに null/undefined が含まれると、クライアントのレンダーやハイドレーション時に例外が発生する可能性がある。
- ダッシュボード配下に専用のエラーバウンダリがなく、例外が上位で捕捉されないと白画面のままになる。

### 対処法
- **OrganizationForm.tsx** で null 安全化を行う。小組・地区の `id` / `name` / `district_id` を表示・編集時に `?? ""` でフォールバックし、`key` や `value` に undefined を渡さないようにする。
- **(dashboard)/error.tsx** を追加し、ダッシュボード配下（枠組設定含む）で発生したエラーをキャッチして「エラーが発生しました」と「再試行」を表示する。

### 対処結果
- 小組一覧・地区選択の表示・編集で null/undefined によるクラッシュを防止。エラー時はダッシュボード用エラーバウンダリでメッセージが表示され、白画面にならない。

---

## 2. 上記対応後もまだまっ白のまま

### 現象
- null 安全化や (dashboard)/error.tsx を追加したあとも、画面がまだまっ白のまま。

### 原因
- サーバー側で `createClient()`（server.ts）が環境変数未設定時に throw しており、ルート（`/`）やダッシュボード配下のレイアウトで例外がそのまま伝播すると、Next.js がエラー画面を出せず白画面になることがある。
- ルートページや (dashboard)/layout で例外を握りつぶさずに上位に投げているため、ユーザーには何も表示されない。

### 対処法
- **app/page.tsx** で `createClient()` と `getUser()` を try/catch で囲み、環境変数に関するメッセージの例外のときだけ「召会生活統計」とメッセージを表示するフォールバックを返す（throw しない）。
- **(dashboard)/layout.tsx** でも同様に try/catch し、環境変数エラー時は「環境変数が未設定です」などのメッセージを表示する div を返す。
- これにより、環境変数未設定でも白画面にならず、設定手順が分かるメッセージが表示される。

### 対処結果
- 環境変数未設定時はルート・ダッシュボードともに白画面にならず、メッセージが表示される。.env.local を設定し、サーバー再起動後に再度アクセスすれば通常表示になる。

---

## 3. 小組一覧の「編集」ボタンを押しても何も起きない（無反応）・URL が変わらない

### 現象
- 枠組設定の小組一覧で「編集」を押しても、編集フォームに切り替わらない（無反応）。
- 行全体を大きなボタンにしても無反応。その後、編集をリンク（`?edit=id`）に変更しても、クリックしても URL が変わらない。

### 原因
- 小さい「編集」ボタンや React の `onClick` による state 更新が、タッチデバイスや環境によっては発火していない可能性がある。
- Next.js の `<Link>` でもクライアント側のナビゲーションが効かず、URL が更新されないケースがあった。

### 対処法
- **編集のトリガーを URL クエリに変更。** 編集状態を `?edit=グループID` で管理し、`useSearchParams()` で `edit` を読んで編集フォームを表示する。
- **小組名＋「編集」を通常の `<a href="/settings/organization?edit=...">` に変更。** リンククリックでブラウザがその URL に遷移するため、JS に依存せず確実に編集モードに入る。枠組設定ページでは `OrganizationForm` を `<Suspense>` でラップ（`useSearchParams` 利用のため）。
- **削除**は従来どおり別ボタンのままにする。

### 対処結果
- 小組名や「編集」のリンクをクリックすると URL が `?edit=...` に変わり、編集フォームに切り替わる。

---

## 4. 編集モードになってもテキストフィールドに元の小組名が表示されない

### 現象
- 編集状態（`?edit=id`）になっても、小組名のテキストフィールドや地区セレクトに元の値が入らない（空のまま）。

### 原因
- 編集フォームの `value` が `editGroupName` / `editGroupDistrictId` のみで、これらは `useEffect` でセットされるため、初回描画時やタイミングによっては空のままになる。

### 対処法
- **表示時にフォールバックする。** 入力欄は `value={editGroupName || (g.name ?? "")}`、地区セレクトは `value={editGroupDistrictId || (g.district_id ?? "")}` とし、state が空のときは編集対象の小組（`g`）の名前・地区を表示する。
- **保存時もフォールバックする。** `saveEditGroup` 内で編集対象グループを `groupsList` から取得し、`nameToSave` / `districtToSave` を state が空の場合はグループの値で埋める。これで未セットのまま保存されることを防ぐ。

### 対処結果
- 編集リンクを開いた時点でテキストフィールドに元の小組名、地区セレクトに元の地区が表示される。

**補足:** 地区の編集も小組と同様、URL クエリ（`?edit_district=地区ID`）で編集モードを開き、インライン編集フォームで地区名を変更する。無反応・値が表示されない事象は、小組と同様の方式（`<a href="...">` と表示・保存時のフォールバック）で防止している。

---

## 5. v0.2 でのその他の注意・安定化のポイント

以下の対応は「事象→対処」ではなく、v0.2 で行った安定化・運用上の注意として記録する。

### マイグレーションの実行順

- **現象:** 002〜007 を飛ばして実行したり順序を逆にすると、カラム不存在・型不整合でエラーになることがある。
- **対処:** 001 実行済みの環境では **002 → 003 → 004 → 005 → 006 → 007** の順に SQL Editor で実行する。詳細は ReleaseNote_0.2.md の「データベース（マイグレーション）」を参照。

### 統計ページの遅延読み込み

- **対応内容:** `StatisticsCharts`（recharts・html-to-image）を `next/dynamic` で遅延読み込み（`ssr: false`）にした。統計ページ表示時のみチャート用ライブラリをロードする。
- **注意:** 統計ページでエラーが発生した場合は、(dashboard)/error.tsx でキャッチされ「エラーが発生しました」と表示される。白画面にはならない。

### ルートレイアウトと白画面の切り分け

- **対応内容:** v0.1 で追加した `GlobalErrorHandler` をルートレイアウト（`app/layout.tsx`）から外し、`body` に `{children}` のみを表示する構成に変更した。
- **理由:** 白画面の原因切り分けのため。ルートで例外が起きたときに、ハンドラの有無による挙動差を減らし、`app/page.tsx` や `(dashboard)/layout.tsx` の try/catch でメッセージを返すようにした。
- **インラインスタイル:** ルートの body、ルートページ・ダッシュボードレイアウト・global-error の主要ブロックにインラインスタイルを追加し、CSS 未読込時も背景・文字色が表示されるようにした。

### テスト用ページ（/test）

- **用途:** 白画面の切り分け用。静的表示のみで Supabase や認証に依存しない。
- **運用:** 本番では削除してよい。問題再現時に「/test だけ表示されるか」でルート・認証・DB のどれで落ちているかを切り分けられる。

