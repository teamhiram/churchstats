# 召会生活統計システム 完全仕様書 (spec5)

## 1. プロジェクト概要

* **目的:** 召会生活におけるメンバー管理、出欠確認、および統計分析の自動化。
* **開発スタック:** Cursor (React/Next.js), Supabase (Auth/DB/Edge Functions), Vercel (Hosting).
* **主要管理者:** `tatsuya.n@gmail.com`

### 1.1 開発環境

* Cursor で開発（React/Next.js）。
* リポジトリは **Github に Private で登録**。
* **Github 経由で Vercel にデプロイ**しホスティングする。

---

## 2. システム構成・データ構造

### 2.1 組織階層

1. **地方 (Locality):** 最上位区分（例：調布、東京、町田。管理者が追加可能。当初は調布のみ）。
2. **地区 (District):** 地方の下位区分。報告の基本単位。
3. **小組 (Group):** 地区を細分化したグループ。最小単位。ローカルメンバーは原則いずれかの小組に所属させる。
* **無所属リスト:** 所属が決まっていないメンバーの一時待機場所。ここから振り分け先（小組等）に割り当てる。

### 2.2 集会の名称ルール

* **主日集会:** 地区集会。名前は「XX地区集会」「OO地区集会」の形式（合同集会）。
* **小組集会:** 名前は「XX小組」の形式で付ける。

### 2.3 データベース設計 (Table Schema)

#### ① 組織・グループ系

* `localities`: `id`, `name`
* `districts`: `id`, `locality_id`, `name`
* `groups`: `id`, `district_id`, `name`

#### ② 集会（イベント）系 (`meetings`) ※ファーストクラスエンティティ

* `id`, `event_date`, `meeting_type` (主日/小組)
* **主日集会:** `district_id`（どの地区の地区集会か）, `name`（例：「調布地区集会」）
* **小組集会:** `group_id`（どの小組の小組集会か）, `name`（例：「XX小組」）
* 集会そのもの（例：2025-02-02 調布地区集会）を1レコードで登録する。出席報告はこの `meeting_id` に紐づける。

#### ③ メンバー系 (`members`)

* `id` (UUID), `name`, `gender`, `is_local` (ローカル/ゲスト)
* `district_id`（このメンバーが属する地区を明示）, `group_id`（小組。データ上は地区→小組はだぶりなく分ける）
* `current_category` (大人/大学生/高校生/中学生/小学生/子供)
* `is_baptized` (boolean)。**統計上の「聖徒/友人」:** バプテスマ済み＝聖徒、未＝友人として統計に使用する。
* `baptism_year`, `baptism_month`, `baptism_day`（各整数。月日不明の場合は NULL 可）
* `baptism_date_precision`（確定 / 不明 / おおよそ）
* **`languages`:** `main`（母語、または配信されるメルマガの言語の好み）, `sub`（メインの他に話せる言語・注）
* `follower_id`（欠席した時にフォローする人）
* **`vital_group_member_ids`:** 日常的に関わりあう3–4名を、**メンバーIDのリストとして JSON 等で保持**。地方のリストから選択。※バイタルグループのグラフィックビュー（Obsidian のようにノードで関係を可視化する画面）を提供する。

#### ④ レギュラーメンバーリスト (`regular_member_list_items`)

* `id`, `meeting_id`（集会ID）, `member_id`（メンバーID）, `sort_order`（並び順用の数値）
* **並び順の選択:** 読み仮名順・登録順・信仰順のいずれかを選べる。レギュラーメンバーリスト作成時は**全地方のメンバーから選ぶ**ことができる。

#### ⑤ 出席記録系 (`attendance_records`) ※スナップショット方式

* `id`, **`meeting_id`**（どの集会への出席か）, `member_id`
* **`recorded_category`**: 報告時点の区分 (統計用)
* **`recorded_is_baptized`**: 報告時点のバプテスマ状態 (統計用)
* `district_id`, `group_id`: **報告時点の所属**（地区・小組とも変わる可能性があるため、報告時点の値を保持する）

#### ⑥ ユーザー・ロール系 (`profiles` 等、Supabase Auth 連携)

* 管理者・共同管理者・報告者・閲覧者の**アカウント**（メール、Supabase Auth と連携）
* **ロール:** 管理者 / 共同管理者 / 報告者 / 閲覧者
* **報告者の所属地区:** 報告者は複数地区を担当可能。`reporter_districts` 等で「担当可能な地区」を保持。**メイン担当地区**は **`main_district_id`** を profiles（または reporter 用テーブル）に**1カラム追加**して保持し、初期表示はその地区の統計画面とする。初期設定では**地方内の全地区にチェックが入った状態**とし、担当地区はチェックボックスで選択する。将来的に一部の地区を権限から除外する仕組みを用意する。

#### ⑦ 履歴管理系 (`attribute_histories`)

* `member_id`, `attribute_type` (区分/バプテスマ), `old_value`, `new_value`, `changed_at`

### 2.4 集会の作成フロー

* **誰が:** 報告者または管理者・共同管理者が集会を作成する。
* **何を登録するか:** 日付・集会種別（主日/小組）・主日の場合は地区、小組集会の場合は小組を選択し、名前（例：「XX地区集会」「XX小組」）を付けて1件の「集会」を登録する。
* **主日集会:** 地区単位で、1日につき1地区1集会を想定。
* **小組集会:** 小組ごとに、日付を選んで集会を登録する。

---

## 3. 出欠報告・運用機能

### 3.1 報告の仕方

* 報告は**地区ごと**に行う。
* 報告者には**あらかじめメイン担当地区の統計画面が表示**される。報告者は**複数地区を担当可**で、**別地区についても報告**できる。
* 担当地区はチェックボックスで選択。**初期状態は地方内の全地区にチェックが入った状態**。将来的に一部の地区を権限から除外できる仕組みを用意する。

### 3.2 報告プロセス（スマート追加機能）

* **出席候補者リスト（レギュラーメンバーリスト）:** 各集会に紐づくリスト。集会ごとにリストを作成でき、いち早く出席者を登録できる。集会作成時には所属メンバーを自動展開。
* **フリー入力検索:** 出席報告画面に検索窓を設置。
* **既存一致:** 名簿にある場合は候補を表示し、選択して出席登録。
* **新規追加:** 名簿にない場合、その場で「新規友人」として簡易登録（氏名・性別・区分等）し、そのまま出席処理を行う。

#### 同時編集・重複出席の扱い

* 同じ集会の出席を複数人が同時に報告した場合、**提出をストップし、重複した名前をアラート表示**する。
  * 例：「XXさんは報告者「OO」さんによって登録済みです。」
* **同じ日の地区集会において、ダブル出席は認めない。** 同一メンバーを同日の別地区集会に登録しようとした場合もアラートを出す。
  * 例：「XXさんは同日の「▽▽地区集会」に「OO」さんによって登録済みです。」

### 3.3 年度更新サポート（3月末）

* **進級対象者リスト:** 毎年3月末に、学年（区分）の変更可能性があるメンバーを自動抽出（例：小6）。
* **一括更新提案:** システムが次年度の区分（中1など）を提案。管理者は「承認・変更・却下」を選択するだけで一括更新が可能。

### 3.4 名簿統合（重複排除）

* 同一人物を誤って二重登録した場合、一方をメインとして統合。
* 過去の `attendance_records` の `member_id` を全てメイン側に書き換え、重複データを削除する。

---

## 4. 小組リスト・名簿運用

* 召会全体の所属が「ローカル」のメンバーを**もれなくどれか一つの小組に所属**させる。**ゲストは地方のメンバーではないので、小組に所属させない。**
* **小組の作成**は管理者・共同管理者が行える（※権限マトリクス 6 参照）。
* **小組へのメンバー追加・削除**は、報告者でも行える（※権限マトリクス 6 参照）。
* 無所属リストから振り分け先の小組に割り当てる。

---

## 5. データ整合性と統計

### 5.1 統計データの整合性

* **時点データの保持:** 後からメンバーの現在属性が変わっても、過去の統計結果（「子供の出席数」など）が変わらないよう、報告時の値を保持する。
* **不整合アラート:** `attendance_records` の値と `attribute_histories` から逆算される「本来の属性」を照合。矛盾がある場合に警告を表示。
* **遡り修正:** 属性変更漏れが判明した場合、過去の統計データを一括修正できる機能を提供。

### 5.2 統計ダッシュボード

* サイトの**トップにはダッシュボード**を表示する。
* **召会全体・地区ごと・小組ごと**の重要な統計結果を視覚的に提示する。
* **重要指標:** 期間別・属性別（男/女、聖徒/友人、大人/子供）の人数推移グラフ。**「子供」の範囲は小学生まで**とする。
* **グラフ・テーブルの集計期間をユーザーが変更できる**ようにする。
* **アクティブ率:** 過去4週間の出席率（1回以上出席した割合）。
* **欠席アラート:** 過去(X)週間出席していた「ローカル」メンバーの今週欠席リストを表示。**X はシステム全体の設定**とし、初期値 4・範囲 1〜52 をドロップダウンで選択可能（管理者が変更）。
* **閲覧者が見られる範囲:** 地区・小組を選んで統計を閲覧できる。

---

## 6. 権限マトリクス

| 権限 | ユーザー管理 | 組織・小組設定 | 小組名簿の追加・削除 | 名簿統合・遡り修正 | 集会作成・出欠報告 | レギュラーメンバーリスト作成 | 統計閲覧 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| **管理者** | 全て | ○ | ○ | ○ | ○ | ○ | ○ |
| **共同管理者** | 報告者承認等(※1) | ○ | ○ | ○ | ○ | ○ | ○ |
| **報告者** | × | × | ○(※2) | × | ○ | ○ | ○ |
| **閲覧者** | × | × | × | × | × | × | ○ |

* **(※1)** 共同管理者は、管理者のアカウント設定（パスワード・メールアドレス等）を変更できない。管理者は共同管理者を削除できる。管理者・共同管理者は複数存在できる。
* **(※2)** 報告者は小組の「作成・削除・名前変更」はできないが、小組名簿へのメンバー追加・削除は可能。

---

## 7. 管理者・ユーザー管理機能

### 7.1 管理者の権限

* 管理者の**メールアドレスを変更**する機能。
* **管理者・共同管理者の追加:** 苗字、名前、メールアドレス、ロール（管理者・共同管理者・報告者・閲覧者）。
* **報告者の承認・却下・削除。**
* **小組の作成。**

### 7.2 報告者の追加フロー

* **承認フロー:** 管理者がメールアドレスを指定して報告者（または閲覧者）を追加するだけ。申請フローはない。
* 報告者追加時：メールアドレスを指定。**パスワードは初期ランダム自動生成**し、**メールで通知**する。
* **初回ログイン（アクティベート）されたら、管理者にメールを送る。** メール報告パターン：報告者/閲覧者が初回ログインした場合 → 管理者・共同管理者に通知。共同管理者が初回ログインした場合 → 管理者に通知。
* **初回ログイン後、パスワード変更を推奨するメッセージ**を表示する。
* パスワード通知メールが送信失敗した場合の**再送・手順**を用意する。

### 7.3 報告者の権限（明示）

* **集会の作成**
* **小組名簿へのメンバー追加・削除**
* **レギュラーメンバーリスト（出席候補者リスト）の作成**

---

## 8. 非機能要件

* **監査ログ:** 誰がいつ・どのデータを変更したかの記録を保持する。
* **ログインログ:** ログイン履歴を記録する。**共同管理者以上**が閲覧できる。
* **バックアップ・リストア:** **アプリ内から**エクスポート/インポートを提供する。
* **統計グラフのダウンロード:** 統計ダッシュボードのグラフを**PNG形式**でダウンロードする機能を提供する。
* **UI・デバイス:** ワイヤーフレームは作らない。画面構成・レイアウトは実装に任せる。**スマホでも操作可能**とし、**スマホ利用を主想定**（モバイルファースト）とする。
* **UI言語:** 日本語のみでよい。

---

## 9. エッジケース・例外処理

* **最後の1人の管理者:** 管理者が自分を削除したりロール変更したりして、管理者が0人にならないように**制御を入れる**（最後の1人の管理者は削除・ロール変更不可とする等）。
* **小組の削除:** 小組を削除した場合、所属メンバーを**無所属リストに移す**。
* **地区の削除:** 地区を削除した場合、下位の小組・集会・出席履歴は**過去の事実として変更しない**（削除しない。参照のみ制御する等）。
* **名簿統合の取り消し:** 統合を誤った場合の**ロールバック**と**統合履歴の保持**を用意する。
* **重複ログイン・セッション:** 同一アカウントの複数デバイス・複数タブでの利用を**許可する**。
