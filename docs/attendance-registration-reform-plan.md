# 出欠登録画面の回改修計画

v0.10　Appendix
2026/02/11

## Phase 1: 基盤（下準備・モード分離・保存ステップ）

### 1.1 下準備

1. **出欠のNULL変換削除**  
   出欠の読み込み時に NULL を true に変換する処理を削除する。出欠に `false` / `true` の2種類が存在することを想定する。

2. **閲覧モードと登録モードの分離**  
   出欠登録画面を編集モードと閲覧モードに分ける。デフォルトは閲覧モードとする。

### 1.2 閲覧モード

3. **閲覧モードのデータソース**  
   閲覧モードは `attendance_records` を fetch して表示する。レギュラーモードは使用しない。

4. **空状態の表示**  
   何も登録されていない場合に「まだ記録はありません。」を表示する。

5. **登録がある場合の表示**  
   登録がある場合は一覧テーブルで表示する。

6. **表示設定**  
   表示設定は閲覧モードでも利用可能とする。ただし、フリー検索は無効化する。

7. **固定行とモード切替**  
   タブ直下に固定行（fixed）を設け、ボタン「記録モードに切り替える」を置く。クリックで記録モードに遷移する。  
   - PC: グロナビ直下に stick  
   - スマホ: グロナビはフッターのため影響なし  

### 1.3 登録モードの保存ステップ

8. **保存ステップの導入**  
   「記録モードに切り替える」をクリックすると、[キャンセル] [保存する] の2ボタンに置き換える。  
   登録モードでは DB への即時反映は行わず、[保存する] クリック後に初めて `attendance_records` に反映する。

9. **欠席の明示的記録**  
   まだ教会に来たことがない者を「記録なし＝欠席」と扱わない。  
   `attendance_records` に残すのは出席・欠席の2種類のみとする。

---

## Phase 2: 在籍期間の管理

### 2.1 名簿カラムの追加

10. **ローカルメンバー転入日・転出日**  
    名簿に「ローカルメンバー転入日」と「ローカルメンバー転出日」のカラムを追加する。SQL 文も作成する。

### 2.2 在籍期間外の扱い

11. **レギュラーリスト表示での除外**  
    在籍期間外のメンバーは、レギュラーリストにあってもデフォルトでは表示しない。

12. **フリー検索ヒット時の扱い**  
    在籍期間外のメンバーがフリー検索でヒットした場合は赤文字で表示する。  
    クリック時にポップアップで「このメンバーは在籍期間外です。名簿編集にて「ローカルメンバー転入日」や「ローカルメンバー転出日」をご確認ください。」と警告し、追加を阻止する。

---

## Phase 3: 出欠記録からの除外・削除

### 3.1 赤丸「−」による除外

13. **除外ボタンの設置**  
    名前の左側に赤丸の「−」記号を設ける。クリックでその名前は出欠編集画面から消える。

14. **保存時の挙動**  
    除外された名前は保存時に `attendance_records` に書き込まない。既存レコードがあれば削除する。  
    編集セッション中のみ表示から消す（保存時に DB に書き込まない／既存レコードがあれば削除）。

### 3.2 レギュラーリスト登録者へのポップアップ

15. **レギュラーリスト登録者への確認**  
    レギュラーリストに登録されている名前を除外する場合、以下のポップアップを表示する。

    ```
    レギュラーリストに登録されている名前です。
    レギュラーリストからも削除しますか？
    過去の記録に影響はありません。今週以降に影響します。地区のレギュラーリストから外れると、今後その地区の主日の登録モードで「レギュラーリストで補完する」を押したときに、その名前一覧に含まれなくなります。

    [キャンセル] [削除する] [削除しない]
    ```

16. **RLS 権限の拡張**  
    現状、`district_regular_list` / `group_regular_list` の INSERT/UPDATE/DELETE は admin / co_admin のみ可能（012 マイグレーション）。報告者にもレギュラーリストの操作権限を付与するように権限を拡張する。

---

## Phase 4: レギュラーリスト補完・フリー検索

### 4.1 レギュラーリストの条件付き無効化

17. **初回と2回目以降の違い**  
    - 初回登録: レギュラーリストをベースに登録する。  
    - 2回目以降: 閲覧モード→登録モードのとき、レギュラーリストは使わず、既存の出欠記録のみをベースにする。

### 4.2 レギュラーリストで補完する

18. **補完ボタン**  
    「レギュラーリストで補完する」ボタンを設ける。

19. **補完対象の定義**  
    - 主日・祈祷会: 選択地区の `district_regular_list` のうち、まだ記録にない人  
    - 小組: 選択小組の `group_regular_list` のうち、まだ記録にない人  

20. **[追加待ち] グループ**  
    補完で追加された名前は一時グループ「追加待ち」として一番上に表示する。出欠トグルのデフォルトは欠席。この状態では DB には追加されない。

21. **[追加する] ボタン**  
    行の右端に「追加する」ボタンを設ける。クリックで「追加待ち」から外れ、通常のグループ（グルーピング設定に従う）に加わる。

### 4.3 フリー検索ポップアップ

22. **ポップアップの表示**  
    フリー検索で名前がヒットしたとき、クリックしても即時追加せず、ポップアップを表示する。

23. **ポップアップの内容**

    **名簿簡易編集**（セクションタイトル、太字）  
    - 「レギュラーリストに加える」トグル（ON で下記ドロップダウン表示）。既にレギュラーリストにある場合は ON で表示。  
    - レギュラーリストは地区と小組のリスト（集会別ではない）。  
    - [XX地区 ▽] — 登録済みならその値、未登録ならデフォルトは無所属（undefined）  
    - [XX小組 ▽] — 登録済みならその値、未登録ならデフォルトは無所属（undefined）

    **出欠状況を選んでください**（セクションタイトル、太字）  
    - [出席 | 欠席] — デフォルトは出席  
    - オンライン — 主日・祈りの集会のみ、かつ出席時のみ表示。デフォルトは OFF。  
    - 他地方で出席 — 主日・祈りの集会のみ、かつ出席時のみ表示。デフォルトは OFF。  

    **メモ**  
    - テキストフィールド  

    [キャンセル] [追加する]

---

## Phase 5 前の準備

### 5.0 attendance_records の拡張

- **recorded_is_local の追加**  
  `attendance_records` に `recorded_is_local` カラムを追加する。記録時点でのローカル判定（名簿の `is_local`）を保存する。

- **既存レコードの backfill**  
  既存レコードは `recorded_is_local` が NULL のため、名簿の現時点における `is_local` をもとに UPDATE する。

---

## Phase 5: 合同集会・共通化

### 5.1 在籍判定の補足

- **local_member_join_date が NULL の場合**  
  `local_member_join_date` が NULL の場合は在籍扱いと読み替える（転入日未設定＝従来通りの在籍として扱う）。

### 5.2 合同集会

24. **合同集会トグル**  
    出欠登録の主日集会タブで、主日の日付の右に「合同集会」トグルを設置する。デフォルトは OFF。

25. **合同集会時の集会形式**  
    ON のとき、集会は地区ごとではなく「[地方名]+[合同集会]」の1集会として登録する。いずれの地区で ON にしても地方全体に適用する。

26. **既存データの統合**  
    保存時、既存レコードが地区別に複数集会になっている場合、合同集会の形に統合して修正する。

### 5.3 共通化

27. **共通コンポーネント化**  
    主日・祈祷会・小組の実装は3ページに分散しているため、共通コンポーネント／フックにまとめる。集会種別による差分（オンライン・他地方の有無など）のみ分岐させる。

---

## Phase 6: 保存漏れ防止・エラー処理

### 6.1 保存漏れ防止

28. **離脱時の確認ダイアログ**  
    保存前にページを離脱する際、以下の確認ダイアログを表示する。

    ```
    出欠内容を保存していません。
    このままページを離れますか？
    ```

29. **戻るボタンでの復元**  
    ブラウザの履歴・戻るで戻ったときに、編集内容を復元する。

### 6.2 保存失敗時の処理

30. **保存失敗時の処理**  
    保存失敗時のエラー表示、リトライ、ロールバックなどを適切に設計・実装する。
