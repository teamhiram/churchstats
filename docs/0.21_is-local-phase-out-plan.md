# members.is_local 廃止計画

名簿の「ローカル/ゲスト」区分を `members.is_local` ではなく、**地方（locality_id）の有無と出欠記録の recorded_is_local** に寄せて廃止していくための計画。

---

## 1. 背景・方針

- **現状**: `members.is_local`（boolean）で「ローカルメンバー / ゲスト」を区別している。ローカルは地区・小組・在籍期間を持つ。
- **方針**:
  - **名簿取得**: 地方ごとの名簿は `members.locality_id` で取得する。`locality_id` が NULL のメンバーは名簿に含めない（✅ 本対応で実施済み）。
  - **出欠記録**: 履歴はそのまま残す（他地方からゲスト参加の記録も残す）。
  - **recorded_is_local**: 記録時点で「その集会の地方」と「メンバーの locality_id」が一致するときのみ TRUE とする（✅ 本対応で実施済み）。`is_local` は参照しない。
- **ゴール**: `is_local` を参照する処理を順次削除し、最終的にはカラムの削除または非推奨化を検討する。

---

## 2. 実施済み（今回の対応）

| 項目 | 内容 |
|------|------|
| 名簿取得 | 地方指定時は `locality_id.eq.${id}` のみとし、`locality_id.is.null` を付けない。NULL のメンバーは名簿に含めない。 |
| recorded_is_local | 主日出欠（lordsday_meeting_attendance）の記録・更新時に、`member.locality_id === 集会の地方` のとき TRUE、それ以外 FALSE。`is_local` は使わない。 |
| 対象箇所 | 名簿: members/page, api/members, dashboard/page, dashboard/actions, dashboard/attendanceMatrixActions。出欠: SundayAttendance.tsx（4箇所）, AttendanceReport.tsx（insert）。 |

---

## 3. is_local 参照箇所と剥がし順

### 3.1 表示・フィルタ（locality で代替可能）

| ファイル | 用途 | 剥がし方 |
|----------|------|----------|
| **MembersList.tsx** | 一覧の「ローカル/ゲスト」表示、小組の「未所属」表示、在籍期間表示の有無 | 「ローカル」⇔ `locality_id != null` で表示。「ゲスト」⇔ `locality_id == null`。小組は locality スコープで「未所属」は「地区内で小組未設定」の意味に。 |
| **members/[id]/page.tsx** | 詳細の「ローカル/ゲスト」「未所属」、在籍期間セクション表示 | 上記と同様。在籍期間は `locality_id != null` のとき表示（member_local_enrollment_periods が locality 紐づきになったらそのまま）。 |
| **MembersPageClient.tsx** | フィルタ「ローカルのみ/ゲストのみ」、isUnassigned（未所属） | フィルタを「地方あり/地方なし」に変更。isUnassigned は「locality_id ありかつ (district_id なし or group_id なし)」に変更。 |
| **dashboard/page.tsx** | メンバー一覧の select に is_local を含む | locality スコープのみで取得しているため、is_local は削除可能。表示で is_local を使っていなければ select から外す。 |
| **dashboard/actions.ts** | getDispatchMonitorData の localMemberIds（欠席者リストの母集団） | 地方スコープで取得したメンバーはすべて「その地方のメンバー」なので、`filter(m => m.is_local)` をやめ、全件を localMemberIds にしてもよい。 |
| **dashboard/attendanceMatrixActions.ts** | getAttendanceMatrixData の isLocal | マトリクス表示で「ローカル」かどうかは recorded_is_local や locality で判定する方針なら、members の is_local を返さず、locality_id != null で代替。 |
| **statistics/StatisticsCharts.tsx** | localMemberIds（棒グラフのローカル人数） | 集計対象を「locality_id = 現在の地方」のメンバーに変更。is_local をやめる。 |

### 3.2 編集・保存（is_local の書き込みをやめる）

| ファイル | 用途 | 剥がし方 |
|----------|------|----------|
| **members/[id]/edit/page.tsx** | initial.is_local | フォームの「ローカル/ゲスト」トグルを「地方あり/地方なし」に変更。保存時は locality_id の有無で district_id / group_id / 在籍期間の有無を決める。 |
| **members/[id]/edit/EditMemberForm.tsx** | is_local  state / 送信 | 上記に合わせて「地方」選択に一本化。locality_id が null ならゲスト扱い（地区・小組・在籍期間は null）。 |
| **members/[id]/edit/actions.ts** | updateMemberAction の is_local, district_id, group_id, locality_id | locality_id を主とし、locality_id が null のとき district_id / group_id を null に。is_local は送信しない（または DB では locality_id から導出するようにして廃止）。 |
| **members/new/page.tsx** | 新規メンバーの is_local | 新規も「地方」選択にし、locality_id の有無でローカル/ゲストを表現。 |

### 3.3 週別集計・リスト（localOnly と is_local）

| ファイル | 用途 | 剥がし方 |
|----------|------|----------|
| **meetings/list/actions.ts** | localOnly フィルタ、members の is_local、localMemberIds | 「ローカルのみ」を「選択中の地方のメンバーのみ」に変更。members は locality_id でスコープ済みなら is_local でフィルタしない。localMemberIds は locality スコープのメンバー全員でよい。 |

### 3.4 DB・マイグレーション

| 対象 | 内容 |
|------|------|
| **member_local_enrollment_periods** | 在籍期間は「その地方での在籍」なので locality_id を追加済み（別対応）。is_local に依存しない。 |
| **members.is_local** | 全参照を locality_id に置き換えたのち、カラムを削除するか、トリガーで `locality_id IS NOT NULL` と同期させるか検討。削除する場合は、既存データで `is_local = true` だった行は `locality_id` が設定されている前提でマイグレーション。 |
| **021_member_local_enrollment_periods** | 既存マイグレーションの「is_local = true」はデータ移行時の条件。新規環境では locality_id ベースに移行済みなら 021 の条件は触らなくてもよい（履歴として残す）。 |

---

## 4. 推奨実施順

1. **Phase 1（表示の置き換え）**  
   MembersList / members/[id]/page / MembersPageClient / dashboard / attendanceMatrixActions / StatisticsCharts で、表示・フィルタ・集計に `locality_id != null` を使うようにし、`is_local` を参照しないようにする。

2. **Phase 2（編集の置き換え）**  
   編集フォームと updateMemberAction で「ローカル/ゲスト」を「地方の有無」に変更。保存時に is_local を書き込まない（または DB で computed にする）。

3. **Phase 3（週別集計・リスト）**  
   meetings/list の localOnly と localMemberIds を locality スコープのみに統一。

4. **Phase 4（DB）**  
   全アプリ参照を剥がしたあと、`members.is_local` を非推奨コメントにし、必要なら「locality_id IS NOT NULL と同期するトリガー」を入れるか、カラム削除マイグレーションを検討。

---

## 5. 関連ドキュメント

- [multi-region-implementation-record.md](./multi-region-implementation-record.md) — 多地方運用の RLS と locality スコープ
- [attendance-related-tables.md](./attendance-related-tables.md) — 出欠関連テーブル（recorded_is_local の意味）

---

*作成: 2026-02-27（名簿 locality のみ取得・recorded_is_local を locality 一致で設定した対応に合わせて作成）*
